---
title: An Annoying Python Quirk
date: "2019-02-25T16:05:56.281Z"
spoiler: Gotchas when dealing with serializing escaped characters in python
draft: false
keywords: python, escape-characters, environmental-variables, google oauth credentials
---

I recently ran into a scenario where I needed to dynamically generate a Google API `secrets.json` on the CI environment from environmental variables before deploying the application to production. A sample `secrets.json`, generated by Google, looks like this

```json
{
  "type": "service_account",
  "project_id": "sampleapp",
  "private_key_id": "accabaowjewoeowoejwoejwof28cf34a1597515",
  "private_key": "-----BEGIN PRIVATE KEY-----\nDSEESG\nszHgLrWhZL2fIxq0WtKE14NhyoU+DK+kkmBfFfP/Go6190nlpOcUMuSfNLZIvj5v\neZeg8EF1dkxooSJuL5rMbOnkmTcrcQHdapkY2tUTFRoDux2I07yTRK5kbgdHgD8z\nRbUE2vl8+V0J4D6YYgSyemLfTdBicZ3HJF7dLfXtxsqc94l+cS04MZDKvMKn4yr6\niZ2PsEmsVqDjTx/kWCDAFIjlc4z9XVejawiojaeja\nA3rZwbDQRC9KJDSf3nQxWo+uqmtPjIpnexhnelYK4MU0VE6EPV8Vy9zh+l25l7+Z\nYwSY1\netE6a3yq6qeIilFAIqx5Ng==\n-----END PRIVATE KEY-----\n",
  "client_email": "sample-app@msampleappam.gserviceaccount.com",
  "client_id": "232893283298327323623823623823728",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/sample-app%4sampleapp.iam.gserviceaccount.com"
}

```

I needed to do this so that I could add the local version of this secret file to the `.gitignore` list which meant it wouldn't be deployed to the git repository.

I eventually opted to create the following environmental variables
```bash
G_PROJECT_ID=sampleapp
G_PRIVATE_KEY_ID=accabaowjewoeowoejwoejwof28cf34a1597515
G_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nDSEESG\nszHgLrWhZL2fIxq0WtKE14NhyoU+DK+kkmBfFfP/Go6190nlpOcUMuSfNLZIvj5v\neZeg8EF1dkxooSJuL5rMbOnkmTcrcQHdapkY2tUTFRoDux2I07yTRK5kbgdHgD8z\nRbUE2vl8+V0J4D6YYgSyemLfTdBicZ3HJF7dLfXtxsqc94l+cS04MZDKvMKn4yr6\niZ2PsEmsVqDjTx/kWCDAFIjlc4z9XVejawiojaeja\nA3rZwbDQRC9KJDSf3nQxWo+uqmtPjIpnexhnelYK4MU0VE6EPV8Vy9zh+l25l7+Z\nYwSY1\netE6a3yq6qeIilFAIqx5Ng==\n-----END PRIVATE KEY-----\n
G_CLIENT_EMAIL=sample-app@msampleappam.gserviceaccount.com
G_CLIENT_ID=232893283298327323623823623823728
G_CLIENT_X509_CERT_URL=https://www.googleapis.com/robot/v1/metadata/x509/sample-app%4sampleapp.iam.gserviceaccount.com
```

**NB**: _I made use of a `.env` file for these environmental variables_

In my `secret.py` file, I had the following implementation as a first draft

```python
import json
from config_utils import Config # can also be gotten from `from starlette.config import Config`

config = Config(".env")

PROJECT_ID = config("G_PROJECT_ID")
PRIVATE_KEY_ID = config("G_PRIVATE_KEY_ID")
PRIVATE_KEY = config("G_PRIVATE_KEY")
CLIENT_EMAIL = config("G_CLIENT_EMAIL")
CLIENT_ID = config("G_CLIENT_ID")
CLIENT_X509_CERT_URL = config("G_CLIENT_X509_CERT_URL")

def build_client_secret(filename="client-secrets2.json"):
    data = {
        "type": "service_account",
        "project_id": PROJECT_ID,`
        "private_key_id": PRIVATE_KEY_ID,
        "private_key": PRIVATE_KEY,
        "client_email": CLIENT_EMAIL,
        "client_id": CLIENT_ID,
        "auth_uri": "https://accounts.google.com/o/oauth2/auth",
        "token_uri": "https://oauth2.googleapis.com/token",
        "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
        "client_x509_cert_url": CLIENT_X509_CERT_URL,
    }
    obj = ["{", ""]
    with open(filename, "w") as outfile:
        json.dump(data, outfile)

if __name__ == "__main__":
    build_client_secret()
```

But after running this snippet, this was what was generated

```json
{
  "type": "service_account",
  "project_id": "sampleapp",
  "private_key_id": "accabaowjewoeowoejwoejwof28cf34a1597515",
  "private_key": "-----BEGIN PRIVATE KEY-----\\nDSEESG\\nszHgLrWhZL2fIxq0WtKE14NhyoU+DK+kkmBfFfP/Go6190nlpOcUMuSfNLZIvj5v\\neZeg8EF1dkxooSJuL5rMbOnkmTcrcQHdapkY2tUTFRoDux2I07yTRK5kbgdHgD8z\\nRbUE2vl8+V0J4D6YYgSyemLfTdBicZ3HJF7dLfXtxsqc94l+cS04MZDKvMKn4yr6\\niZ2PsEmsVqDjTx/kWCDAFIjlc4z9XVejawiojaeja\\nA3rZwbDQRC9KJDSf3nQxWo+uqmtPjIpnexhnelYK4MU0VE6EPV8Vy9zh+l25l7+Z\\nYwSY1\\netE6a3yq6qeIilFAIqx5Ng==\\n-----END PRIVATE KEY-----\\n",
  "client_email": "sample-app@msampleappam.gserviceaccount.com",
  "client_id": "232893283298327323623823623823728",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/sample-app%4sampleapp.iam.gserviceaccount.com"
}
```

As you can see, the problem is with the escaping of the new line character `\n`. Python has a strange behavior where if a string consist of an escape sequence, the following is observed
```python
>>> variable = "hello\\n"
>>> variable
hello\\n
>>> print(variable)
hello\n
```
But when I create a dictionary from this variable, I run into the following
```python
>>> dictionary= dict(variable=variable)
>>> dictionary
{'variable': 'hello\\n'}
>>> print(dictionary)
{'variable': 'hello\\n'}
# but look at the following
>>> print(dictionary['variable'])
hello\n # the escape value is removed
```
The automatic escaping no longer happens when dealing with a non string object. This is a problem unique to Python alone because python has the concept of raw strings and regular strings.

The solution to my problem ended up being verbose

```python
...
def build_client_secret(filename="client-secrets2.json"):
    ...
    obj = ["{", ""]
    with open(filename, "w") as outfile:
        outfile.write("{")
        for i, (key, value) in enumerate(data.items()):
            string = f'"{key}": "{value}"'
            if i != len(data.items()) - 1:
                string += ","
            outfile.write(string)
        outfile.write("}")
...
````
Hopefully this helps someone who runs into this scenario in understanding what is happening.